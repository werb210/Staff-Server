- name: Use Node
  uses: actions/setup-node@v4
  with:
    node-version: "20"
    cache: "npm"

- name: Install
  run: npm ci

- name: Build
  run: npm run build

- name: Sanity check build output exists
  run: |
    test -f server/dist/index.js
    echo "OK: server/dist/index.js exists"

- name: Create deploy package (compiled app + deps)
  run: |
    rm -f package.zip
    zip -r package.zip \
      server/dist \
      package.json \
      package-lock.json \
      node_modules

- name: Deploy to Azure Web App
  uses: azure/webapps-deploy@v3
  with:
    app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
    publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
    package: package.zip
